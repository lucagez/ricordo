{"version":3,"file":"ricordo.js","sources":["../src/_trap.mjs","../src/ricordo.mjs"],"sourcesContent":["/**\n * Config [object]:\n * - ttl [number] => time-to-live for cached keys.\n * - ideal [number] => ideal number of items to keep cached.\n * - limit [number] => n of items that triggers store behavior.\n * - force [boolean] => force deletion of key after ttl. DEFAULT: `false`.\n */\n\nexport default class _Trap {\n  constructor({ ttl, ideal, limit, force = false }) {\n    this.ttl = ttl;\n    this.ideal = ideal;\n    this.limit = limit;\n    this.force = force;\n\n    if (!ttl || ttl < 1000) throw new Error('prop `ttl` is required when setting up custom caching');\n    if (this.limit && !this.ideal) throw new Error('prop `ideal` is required when setting `limit` prop');\n\n    this.stats = new Map();\n    this.store = new Map();\n  }\n\n  has(key) {\n    return this.store.has(key);\n  }\n\n  get(key) {\n    // Updating stats incrementing usage counter.\n    const n = this.stats.get(key) || 0;\n    this.stats.set(key, n + 1);\n\n    return this.store.get(key);\n  }\n\n  set(key, value) {\n    if (this.limit && this.store.size >= this.limit - 1) this.onLimit();\n\n    // Initializing ttl.\n    setTimeout(() => this.onTimeout(key), this.ttl);\n    return this.store.set(key, value);\n  }\n\n  onTimeout(key) {\n    // When force is set to `true` => key is delete from cache by default.\n    if (this.stats.get(key) === 0 || !this.stats.has(key) || this.force) this.store.delete(key);\n    else {\n      this.stats.set(key, 0);\n      setTimeout(() => this.onTimeout(key), this.ttl);\n    }\n  }\n\n  onLimit() {\n    // Sorting cache keys based on usage.\n    const arr = Array.from(this.stats).sort((a, b) => b[1] - a[1]);\n    arr.length = this.ideal;\n\n    // Building new store from most used cache keys.\n    const newStats = arr.map(e => [e[0], this.store.get(e[0])]);\n    this.store = new Map(newStats);\n  }\n}\n","import _Trap from './_trap';\n\n// This func exposes the newly created `Ricordo` instance.\n// Interacting with the inner class method (private).\nfunction run(...args) {\n  // Avoiding stringification of simple arguments as js store support any type.\n  // By simple I mean every type comparable `simply` with the strict equality operator `===`.\n  // => Comparing simple arrais and objects is simpler by stringifying them\n  // and comparing the resulting strings.\n\n  // NOTE-1: this is not tested with objects with a complex structure.\n\n  // NOTE-2: this func will throw error if a circular structure is provided.\n  // Support for those structures is out of the scope of this library\n  // => Keeping it small and usable also on the browser.\n\n  const key = (() => {\n    if (args.length <= 1) return typeof args[0] === 'object' ? JSON.stringify(args[0]) : args[0];\n    return JSON.stringify(args);\n  })();\n\n  if (this.cache.has(key)) return this.cache.get(key);\n\n  const result = this.func(...args);\n  this.cache.set(key, result);\n  return result;\n}\n\n\nfunction _destroy() {\n  // Destroy previous cache instance and re-initializing to empty tate according to\n  // provided config object.\n  this.cache = this.init(this.config);\n}\n\nconst _init = config => config ? new _Trap(config) : new Map();\n\nexport default class Ricordo {\n  constructor(func, config) {\n    if (typeof func !== 'function') throw new TypeError('func argument must be of type `function`');\n\n    // Used in `run`\n    this.func = func;\n\n    // Useful for `destroy` method.\n    this.init = _init;\n    this.config = config;\n\n    // Key value store used for caching `arguments => results`\n    this.cache = _init(config);\n\n    const expose = run.bind(this);\n    expose.destroy = _destroy.bind(this);\n\n    return expose;\n  }\n}\n"],"names":["_Trap","constructor","ref","ttl","ideal","limit","force","Error","this","stats","Map","store","has","key","get","n","set","value","size","onLimit","setTimeout","onTimeout","delete","arr","Array","from","sort","a","b","length","newStats","map","e","const","_init","config","func","TypeError","init","cache","expose","args","JSON","stringify","result","bind","destroy"],"mappings":"AAQe,IAAMA,EACnBC,SAAYC,gEAA6B,QAClCC,IAAMA,OACNC,MAAQA,OACRC,MAAQA,OACRC,MAAQA,GAERH,GAAOA,EAAM,IAAM,MAAM,IAAII,MAAM,4DACpCC,KAAKH,QAAUG,KAAKJ,MAAO,MAAM,IAAIG,MAAM,2DAE1CE,MAAQ,IAAIC,SACZC,MAAQ,IAAID,KAGnBE,YAAAA,aAAIC,UACKL,KAAKG,MAAMC,IAAIC,IAGxBC,YAAAA,aAAID,OAEIE,EAAIP,KAAKC,MAAMK,IAAID,IAAQ,cAC5BJ,MAAMO,IAAIH,EAAKE,EAAI,GAEjBP,KAAKG,MAAMG,IAAID,IAGxBG,YAAAA,aAAIH,EAAKI,qBACHT,KAAKH,OAASG,KAAKG,MAAMO,MAAQV,KAAKH,MAAQ,GAAGG,KAAKW,UAG1DC,6BAAiBZ,EAAKa,UAAUR,IAAML,KAAKL,KACpCK,KAAKG,MAAMK,IAAIH,EAAKI,IAG7BI,YAAAA,mBAAUR,cAEoB,IAAxBL,KAAKC,MAAMK,IAAID,KAAeL,KAAKC,MAAMG,IAAIC,IAAQL,KAAKF,MAAOE,KAAKG,MAAMW,OAAOT,SAEhFJ,MAAMO,IAAIH,EAAK,GACpBO,6BAAiBZ,EAAKa,UAAUR,IAAML,KAAKL,OAI/CgB,YAAAA,8BAEQI,EAAMC,MAAMC,KAAKjB,KAAKC,OAAOiB,cAAMC,EAAGC,UAAMA,EAAE,GAAKD,EAAE,KAC3DJ,EAAIM,OAASrB,KAAKJ,UAGZ0B,EAAWP,EAAIQ,aAAIC,SAAK,CAACA,EAAE,GAAIxB,EAAKG,MAAMG,IAAIkB,EAAE,YACjDrB,MAAQ,IAAID,IAAIoB,ICvBzBG,IAAMC,WAAQC,UAAUA,EAAS,IAAInC,EAAMmC,GAAU,IAAIzB,oBAGvDT,SAAYmC,EAAMD,MACI,mBAATC,EAAqB,MAAM,IAAIC,UAAU,iDAG/CD,KAAOA,OAGPE,KAAOJ,OACPC,OAASA,OAGTI,MAAQL,EAAMC,OAEbK,EA/CV,wEAYQ3B,EACA4B,EAAKZ,QAAU,EAA6B,iBAAZY,EAAK,GAAkBC,KAAKC,UAAUF,EAAK,IAAMA,EAAK,GACnFC,KAAKC,UAAUF,MAGpBjC,KAAK+B,MAAM3B,IAAIC,GAAM,OAAOL,KAAK+B,MAAMzB,IAAID,OAEzC+B,KAASpC,MAAK4B,WAAKlC,EAAGuC,eACvBF,MAAMvB,IAAIH,EAAK+B,GACbA,GA0BcC,KAAKrC,eACjBsC,QAvBX,gBAGOP,MAAQ/B,KAAK8B,KAAK9B,KAAK2B,SAoBAU,KAAKrC,MAExBgC"}